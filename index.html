<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Professional Stock Tracker (Finnhub)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

<div class="max-w-6xl mx-auto grid lg:grid-cols-4 gap-6">

  <!-- LEFT PANEL -->
  <div class="bg-white rounded-2xl shadow p-4 space-y-4">
    <h2 class="text-xl font-bold">ğŸ“ˆ Stock Tracker</h2>

    <input id="symbolInput" placeholder="AAPL" class="w-full border rounded-lg px-3 py-2" />
    <button onclick="loadStock()" class="w-full bg-blue-600 text-white py-2 rounded-lg">Search</button>

    <div class="flex gap-2">
      <button onclick="setResolution('D')" class="flex-1 bg-gray-200 rounded py-1">Daily</button>
      <button onclick="setResolution('15')" class="flex-1 bg-gray-200 rounded py-1">15m</button>
      <button onclick="setResolution('5')" class="flex-1 bg-gray-200 rounded py-1">5m</button>
    </div>

    <h3 class="font-semibold">â­ Watchlist</h3>
    <ul id="watchlist" class="space-y-2"></ul>

    <h3 class="font-semibold">ğŸ’¼ Portfolio</h3>
    <button onclick="addToPortfolio()" class="w-full bg-green-600 text-white py-2 rounded-lg">Add Position</button>
    <ul id="portfolio" class="space-y-2"></ul>
  </div>

  <!-- MAIN PANEL -->
  <div class="lg:col-span-3 bg-white rounded-2xl shadow p-4 space-y-6">

    <div id="error" class="text-red-600 hidden"></div>

    <div id="stockSection" class="hidden space-y-4">
      <div class="flex justify-between items-center">
        <h1 id="stockTitle" class="text-2xl font-bold"></h1>
        <button onclick="addToWatchlist()" class="bg-blue-600 text-white px-3 py-1 rounded">+ Watch</button>
      </div>

      <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
        <div class="p-3 bg-gray-50 rounded">Price<br><span id="price"></span></div>
        <div class="p-3 bg-gray-50 rounded">Change<br><span id="change"></span></div>
        <div class="p-3 bg-gray-50 rounded">Sentiment<br><span id="sentiment"></span></div>
        <div class="p-3 bg-gray-50 rounded">Updated<br><span id="lastDay"></span></div>
      </div>

      <canvas id="priceChart" height="120"></canvas>

      <div>
        <h3 class="font-semibold mb-2">ğŸ“° Company News</h3>
        <ul id="news" class="space-y-2"></ul>
      </div>
    </div>
  </div>
</div>

<script>
const FINNHUB_KEY = "d5eaap9r01qjckl2rtg0d5eaap9r01qjckl2rtgg";
let currentSymbol = "";
let chart;
let resolution = 'D';

// ---------- STORAGE ----------
const getLS = k => JSON.parse(localStorage.getItem(k) || '[]');
const setLS = (k,v) => localStorage.setItem(k, JSON.stringify(v));

// ---------- WATCHLIST ----------
function addToWatchlist(){
  const list = getLS('watchlist');
  if(!list.includes(currentSymbol)) list.push(currentSymbol);
  setLS('watchlist', list); renderWatchlist();
}
function renderWatchlist(){
  const ul = document.getElementById('watchlist'); ul.innerHTML='';
  getLS('watchlist').forEach(s=>{
    ul.innerHTML += `<li class="flex justify-between bg-gray-100 p-2 rounded">
      <span onclick="loadStock('${s}')" class="cursor-pointer">${s}</span>
      <button onclick="removeFrom('watchlist','${s}')">âœ•</button></li>`;
  });
}

// ---------- PORTFOLIO ----------
function addToPortfolio(){
  const qty = prompt('Shares:');
  const price = prompt('Buy price:');
  if(!qty || !price) return;
  const p = getLS('portfolio');
  p.push({symbol:currentSymbol, qty:+qty, price:+price});
  setLS('portfolio', p); renderPortfolio();
}
function renderPortfolio(){
  const ul = document.getElementById('portfolio'); ul.innerHTML='';
  getLS('portfolio').forEach(pos=>{
    ul.innerHTML += `<li class="bg-gray-100 p-2 rounded">${pos.symbol} | ${pos.qty} @ $${pos.price}</li>`;
  });
}

function removeFrom(k,s){ setLS(k,getLS(k).filter(x=>x!==s)); renderWatchlist(); }

// ---------- RESOLUTION ----------
function setResolution(r){ resolution=r; loadStock(currentSymbol); }

// ---------- LOAD STOCK ----------
async function loadStock(sym){
  currentSymbol = (sym || symbolInput.value).toUpperCase();
  if(!currentSymbol) return;

  try{
    const now = Math.floor(Date.now()/1000);
    const from = now - 60*60*24*30;

    const [q,c,n,s] = await Promise.all([
      fetch(`https://finnhub.io/api/v1/quote?symbol=${currentSymbol}&token=${FINNHUB_KEY}`).then(r=>r.json()),
      fetch(`https://finnhub.io/api/v1/stock/candle?symbol=${currentSymbol}&resolution=${resolution}&from=${from}&to=${now}&token=${FINNHUB_KEY}`).then(r=>r.json()),
      fetch(`https://finnhub.io/api/v1/company-news?symbol=${currentSymbol}&from=2024-01-01&to=2026-12-31&token=${FINNHUB_KEY}`).then(r=>r.json()),
      fetch(`https://finnhub.io/api/v1/news-sentiment?symbol=${currentSymbol}&token=${FINNHUB_KEY}`).then(r=>r.json())
    ]);

    document.getElementById('stockTitle').textContent=currentSymbol;
    price.textContent=`$${q.c.toFixed(2)}`;
    change.textContent=`${q.d.toFixed(2)} (${q.dp.toFixed(2)}%)`;
    change.className=q.d>=0?'text-green-600':'text-red-600';
    lastDay.textContent=new Date(q.t*1000).toLocaleDateString();
    sentiment.textContent=(s.sentiment?.score||0).toFixed(2);

    drawChart(c);
    renderNews(n.slice(0,5));

    stockSection.classList.remove('hidden');
  }catch(e){ error.textContent=e.message; error.classList.remove('hidden'); }
}

// ---------- CHART ----------
function drawChart(d){
  if(d.s!=='ok') return;
  if(chart) chart.destroy();
  chart=new Chart(priceChart,{type:'line',data:{labels:d.t.map(t=>new Date(t*1000).toLocaleDateString()),datasets:[{data:d.c,tension:.3}]},options:{plugins:{legend:{display:false}}}});
}

// ---------- NEWS ----------
function renderNews(list){
  news.innerHTML='';
  list.forEach(a=>news.innerHTML+=`<li class="bg-gray-100 p-2 rounded"><a href="${a.url}" target="_blank" class="font-semibold">${a.headline}</a></li>`);
}

renderWatchlist();
renderPortfolio();
</script>
</body>
</html>
