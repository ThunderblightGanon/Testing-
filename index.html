<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloomberg Finance Dashboard</title>
    <style>
        :root {
            --color-bg-primary: #0a0e27;
            --color-bg-secondary: #1a1f3a;
            --color-surface: #252d47;
            --color-text-primary: #ffffff;
            --color-text-secondary: #a0aec0;
            --color-primary: #00a8e8;
            --color-success: #22c55e;
            --color-error: #ff6b6b;
            --color-warning: #fbbf24;
            --color-border: rgba(255, 255, 255, 0.1);
            --space-8: 8px;
            --space-12: 12px;
            --space-16: 16px;
            --space-24: 24px;
            --space-32: 32px;
            --radius-base: 6px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: var(--color-bg-primary);
            color: var(--color-text-primary);
        }

        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 200px;
            background-color: var(--color-bg-secondary);
            border-right: 1px solid var(--color-border);
            padding: var(--space-16);
            overflow-y: auto;
            flex-shrink: 0;
        }

        .logo {
            font-size: 18px;
            font-weight: 700;
            color: var(--color-primary);
            margin-bottom: var(--space-24);
            letter-spacing: 1px;
        }

        .nav-section {
            margin-bottom: var(--space-24);
        }

        .nav-title {
            font-size: 11px;
            text-transform: uppercase;
            color: var(--color-text-secondary);
            font-weight: 600;
            margin-bottom: var(--space-12);
            letter-spacing: 0.5px;
        }

        .nav-item {
            padding: var(--space-12) var(--space-8);
            margin-bottom: var(--space-8);
            border-radius: var(--radius-base);
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background-color: rgba(0, 168, 232, 0.1);
            border-left-color: var(--color-primary);
        }

        .nav-item.active {
            background-color: rgba(0, 168, 232, 0.15);
            color: var(--color-primary);
            border-left-color: var(--color-primary);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .header {
            background-color: var(--color-bg-secondary);
            border-bottom: 1px solid var(--color-border);
            padding: var(--space-16) var(--space-24);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .search-bar {
            flex: 0 0 300px;
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8) var(--space-12);
            color: var(--color-text-primary);
            font-size: 13px;
        }

        .search-bar::placeholder {
            color: var(--color-text-secondary);
        }

        .search-bar:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(0, 168, 232, 0.1);
        }

        .content {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-16);
            padding: var(--space-24);
            overflow-y: auto;
        }

        .panel {
            background-color: var(--color-surface);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .panel-header {
            padding: var(--space-16);
            border-bottom: 1px solid var(--color-border);
            background-color: rgba(0, 0, 0, 0.2);
        }

        .panel-header h2 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .panel-body {
            padding: var(--space-16);
            flex: 1;
            overflow-y: auto;
        }

        .ticker-card {
            padding: var(--space-12);
            margin-bottom: var(--space-12);
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .ticker-card:hover {
            background-color: rgba(0, 168, 232, 0.1);
            border-color: var(--color-primary);
        }

        .ticker-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: var(--space-8);
        }

        .ticker-symbol {
            font-weight: 700;
            font-size: 14px;
            color: var(--color-text-primary);
        }

        .ticker-price {
            font-size: 14px;
            font-weight: 600;
        }

        .ticker-price.up {
            color: var(--color-success);
        }

        .ticker-price.down {
            color: var(--color-error);
        }

        .ticker-change {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
        }

        .change-value {
            font-weight: 500;
        }

        .change-value.up {
            color: var(--color-success);
        }

        .change-value.down {
            color: var(--color-error);
        }

        .change-percent {
            color: var(--color-text-secondary);
        }

        .news-item {
            padding: var(--space-12);
            margin-bottom: var(--space-12);
            border-left: 3px solid var(--color-primary);
            background-color: rgba(0, 168, 232, 0.05);
            border-radius: var(--radius-base);
        }

        .news-title {
            font-size: 13px;
            font-weight: 600;
            margin-bottom: var(--space-8);
            line-height: 1.4;
        }

        .news-meta {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--color-text-secondary);
        }

        .news-ticker {
            display: inline-block;
            background-color: var(--color-primary);
            color: var(--color-bg-primary);
            padding: 2px 6px;
            border-radius: 3px;
            font-weight: 600;
            margin-right: var(--space-8);
        }

        .market-overview {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-12);
            margin-bottom: var(--space-12);
        }

        .metric-box {
            background-color: rgba(0, 0, 0, 0.3);
            padding: var(--space-12);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
        }

        .metric-label {
            font-size: 11px;
            color: var(--color-text-secondary);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: var(--space-4);
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 18px;
            font-weight: 700;
        }

        .metric-change {
            font-size: 12px;
            margin-top: var(--space-4);
        }

        .metric-change.up {
            color: var(--color-success);
        }

        .metric-change.down {
            color: var(--color-error);
        }

        .sector-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-8);
        }

        .sector-item {
            padding: var(--space-12);
            background-color: rgba(0, 0, 0, 0.3);
            border-radius: var(--radius-base);
            border: 1px solid var(--color-border);
            text-align: center;
        }

        .sector-name {
            font-size: 12px;
            color: var(--color-text-secondary);
            margin-bottom: var(--space-4);
        }

        .sector-change {
            font-size: 14px;
            font-weight: 700;
        }

        .sector-change.up {
            color: var(--color-success);
        }

        .sector-change.down {
            color: var(--color-error);
        }

        .input-group {
            display: flex;
            gap: var(--space-8);
            margin-bottom: var(--space-16);
        }

        .input {
            flex: 1;
            background-color: var(--color-bg-primary);
            border: 1px solid var(--color-border);
            border-radius: var(--radius-base);
            padding: var(--space-8) var(--space-12);
            color: var(--color-text-primary);
            font-size: 13px;
        }

        .input::placeholder {
            color: var(--color-text-secondary);
        }

        .input:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 2px rgba(0, 168, 232, 0.1);
        }

        .btn {
            background-color: var(--color-primary);
            color: var(--color-bg-primary);
            border: none;
            padding: var(--space-8) var(--space-16);
            border-radius: var(--radius-base);
            font-weight: 600;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background-color: #0096c7;
        }

        .btn-danger {
            background-color: transparent;
            color: var(--color-error);
            border: 1px solid var(--color-error);
            padding: 4px 8px;
            font-size: 11px;
        }

        .btn-danger:hover {
            background-color: rgba(255, 107, 107, 0.1);
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: var(--color-text-secondary);
            text-align: center;
        }

        .empty-state-icon {
            font-size: 32px;
            margin-bottom: var(--space-12);
            opacity: 0.5;
        }

        /* Sparkline canvas */
        .sparkline {
            width: 80px;
            height: 24px;
        }

        .ticker-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .alert-row {
            background-color: rgba(251, 191, 36, 0.08);
            border-color: rgba(251, 191, 36, 0.5);
        }

        .alert-badge {
            font-size: 10px;
            text-transform: uppercase;
            padding: 2px 6px;
            border-radius: 999px;
            background-color: rgba(251, 191, 36, 0.2);
            color: var(--color-warning);
            font-weight: 600;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @media (max-width: 1400px) {
            .content {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }

            .header {
                flex-direction: column;
                gap: var(--space-12);
            }

            .search-bar {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="logo">BBGTERMINAL</div>
            <div class="nav-section">
                <div class="nav-title">Markets</div>
                <div class="nav-item active" onclick="switchView('watchlist')">üìä Watchlist</div>
                <div class="nav-item" onclick="switchView('news')">üì∞ News Feed</div>
                <div class="nav-item" onclick="switchView('sectors')">üè¢ Sectors</div>
            </div>
            <div class="nav-section">
                <div class="nav-title">Tools</div>
                <div class="nav-item" onclick="switchView('screener')">üîç Screener</div>
                <div class="nav-item" onclick="switchView('alerts')">üîî Alerts</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <h1 id="headerTitle">Markets Overview</h1>
                <input type="text" class="search-bar" id="searchInput" placeholder="Search stocks, news..." onkeyup="handleSearch()">
            </div>

            <!-- Content Area -->
            <div class="content" id="contentArea">
                <!-- Watchlist Panel -->
                <div class="panel" id="panel-watchlist">
                    <div class="panel-header">
                        <h2>Market Indices</h2>
                    </div>
                    <div class="panel-body">
                        <div id="indicesList"></div>
                    </div>
                </div>

                <!-- Stocks Panel -->
                <div class="panel" id="panel-stocks">
                    <div class="panel-header">
                        <h2>Top Movers</h2>
                    </div>
                    <div class="panel-body">
                        <div class="input-group">
                            <input type="text" class="input" id="symbolInput" placeholder="Add ticker (e.g., AAPL)">
                            <button class="btn" onclick="addToWatchlist()">Add</button>
                        </div>
                        <div id="watchlist"></div>
                    </div>
                </div>

                <!-- News Panel -->
                <div class="panel" id="panel-news">
                    <div class="panel-header">
                        <h2>Breaking News</h2>
                    </div>
                    <div class="panel-body" id="newsFeed"></div>
                </div>

                <!-- Market Overview Panel -->
                <div class="panel" id="panel-overview">
                    <div class="panel-header">
                        <h2>Market Statistics</h2>
                    </div>
                    <div class="panel-body">
                        <div class="market-overview" id="marketStats"></div>
                    </div>
                </div>

                <!-- Sectors Panel -->
                <div class="panel" id="panel-sectors">
                    <div class="panel-header">
                        <h2>Sector Performance</h2>
                    </div>
                    <div class="panel-body">
                        <div class="sector-grid" id="sectorsList"></div>
                    </div>
                </div>
            </div>

            <!-- Details Panel -->
            <div class="panel" id="panel-details" style="display:none; position:absolute; top:80px; right:24px; width:340px; max-height:80vh; z-index:10;">
                <div class="panel-header">
                    <h2 id="detailsTitle">Stock Details</h2>
                </div>
                <div class="panel-body" id="detailsBody">
                    <div style="font-size:13px; color:var(--color-text-secondary); margin-bottom:8px;">
                        Click a stock in the watchlist to view details.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const sampleIndices = [
            { symbol: 'SPX', name: 'S&P 500', price: 5832.41, change: 45.23, percent: 0.78 },
            { symbol: 'INDU', name: 'Dow Jones', price: 42156.34, change: 234.12, percent: 0.56 },
            { symbol: 'CCMP', name: 'Nasdaq', price: 19247.81, change: -12.34, percent: -0.06 },
            { symbol: 'VIX', name: 'Volatility', price: 13.45, change: -0.67, percent: -4.74 }
        ];

        const sampleNews = [
            { title: 'Fed signals pause in rate hikes amid cooling inflation', ticker: 'SPX', time: '2 hours ago', sentiment: 'positive' },
            { title: 'Tesla reports better-than-expected Q4 deliveries', ticker: 'TSLA', time: '3 hours ago', sentiment: 'positive' },
            { title: 'Apple announces new AI features in iOS update', ticker: 'AAPL', time: '4 hours ago', sentiment: 'positive' },
            { title: 'Oil prices rise on supply concerns from Middle East', ticker: 'XLE', time: '5 hours ago', sentiment: 'negative' },
            { title: 'Microsoft cloud division surpasses growth targets', ticker: 'MSFT', time: '6 hours ago', sentiment: 'positive' }
        ];

        const sectors = [
            { name: 'Technology', change: 2.34 },
            { name: 'Healthcare', change: 1.12 },
            { name: 'Finance', change: -0.45 },
            { name: 'Energy', change: -1.23 },
            { name: 'Utilities', change: 0.89 },
            { name: 'Consumer', change: 1.45 },
            { name: 'Industrials', change: 0.67 },
            { name: 'Materials', change: -0.34 }
        ];

        const FINNHUB_API_KEY = 'd5eaap9r01qjckl2rtg0d5eaap9r01qjckl2rtgg';
        const ALERT_THRESHOLD = 2;

        let watchlist = [];
        let currentView = 'watchlist';
        const candleCache = {};

        function init() {
            renderIndices();
            renderNews();
            renderSectors();
            renderMarketStats();
            updateWatchlist();
        }

        function renderIndices() {
            const container = document.getElementById('indicesList');
            container.innerHTML = sampleIndices.map(index => `
                <div class="ticker-card">
                    <div class="ticker-header">
                        <span class="ticker-symbol">${index.symbol}</span>
                        <span class="ticker-price ${index.change >= 0 ? 'up' : 'down'}">${index.price.toFixed(2)}</span>
                    </div>
                    <div class="ticker-change">
                        <span>${index.name}</span>
                        <span>
                            <span class="change-value ${index.change >= 0 ? 'up' : 'down'}">${index.change >= 0 ? '+' : ''}${index.change.toFixed(2)}</span>
                            <span class="change-percent">(${index.percent >= 0 ? '+' : ''}${index.percent.toFixed(2)}%)</span>
                        </span>
                    </div>
                </div>
            `).join('');
        }

        function renderNews() {
            const container = document.getElementById('newsFeed');
            container.innerHTML = sampleNews.map(news => `
                <div class="news-item">
                    <div class="news-title">
                        <span class="news-ticker">${news.ticker}</span>
                        ${news.title}
                    </div>
                    <div class="news-meta">
                        <span>${news.time}</span>
                        <span style="color: ${news.sentiment === 'positive' ? '#22c55e' : '#ff6b6b'}">‚óè ${news.sentiment}</span>
                    </div>
                </div>
            `).join('');
        }

        function renderSectors() {
            const container = document.getElementById('sectorsList');
            container.innerHTML = sectors.map(sector => `
                <div class="sector-item">
                    <div class="sector-name">${sector.name}</div>
                    <div class="sector-change ${sector.change >= 0 ? 'up' : 'down'}">
                        ${sector.change >= 0 ? '+' : ''}${sector.change.toFixed(2)}%
                    </div>
                </div>
            `).join('');
        }

        function renderMarketStats() {
            const container = document.getElementById('marketStats');
            container.innerHTML = `
                <div class="metric-box">
                    <div class="metric-label">Market Open</div>
                    <div class="metric-value">09:30 EST</div>
                    <div class="metric-change">US Equities</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Advance/Decline</div>
                    <div class="metric-value">1,847 / 1,234</div>
                    <div class="metric-change up">+35 Unchanged</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Market Cap</div>
                    <div class="metric-value">$48.2T</div>
                    <div class="metric-change up">+$420B</div>
                </div>
                <div class="metric-box">
                    <div class="metric-label">Yield Curve</div>
                    <div class="metric-value">3.84% / 4.12%</div>
                    <div class="metric-change down">-2bps</div>
                </div>
            `;
        }

        async function fetchRealPrice(symbol) {
            try {
                const response = await fetch(
                    `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${FINNHUB_API_KEY}`
                );
                if (!response.ok) throw new Error(`API error: ${response.status}`);
                const data = await response.json();
                if (typeof data.c !== 'number') return null;
                return {
                    price: data.c,
                    change: data.d ?? 0,
                    percent: data.dp ?? 0,
                    high: data.h ?? null,
                    low: data.l ?? null,
                    open: data.o ?? null,
                    prevClose: data.pc ?? null
                };
            } catch (err) {
                console.error('Finnhub error for', symbol, err);
                return null;
            }
        }

        async function fetchIntradayCandles(symbol) {
            try {
                const now = Math.floor(Date.now() / 1000);
                const from = now - 6 * 60 * 60;
                const url = `https://finnhub.io/api/v1/stock/candle?symbol=${encodeURIComponent(symbol)}&resolution=5&from=${from}&to=${now}&token=${FINNHUB_API_KEY}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Candle API error: ${res.status}`);
                const data = await res.json();
                if (data.s !== 'ok' || !Array.isArray(data.c) || data.c.length === 0) return null;
                return data.c;
            } catch (err) {
                console.error('Candle error for', symbol, err);
                return null;
            }
        }

        function drawSparkline(canvas, prices) {
            if (!canvas || !prices || prices.length < 2) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width;
            const h = canvas.height;
            ctx.clearRect(0, 0, w, h);

            const min = Math.min(...prices);
            const max = Math.max(...prices);
            const span = max - min || 1;

            ctx.beginPath();
            ctx.lineWidth = 1.5;
            ctx.strokeStyle = prices[prices.length - 1] >= prices[0] ? '#22c55e' : '#ff6b6b';

            prices.forEach((p, i) => {
                const x = (i / (prices.length - 1)) * (w - 4) + 2;
                const y = h - ((p - min) / span) * (h - 4) - 2;
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            });
            ctx.stroke();
        }

        async function addToWatchlist() {
            const input = document.getElementById('symbolInput');
            const symbol = input.value.toUpperCase().trim();
            if (!symbol) {
                alert('Please enter a stock symbol');
                return;
            }
            if (watchlist.find(w => w.symbol === symbol)) {
                alert('Stock already in watchlist');
                return;
            }

            const btn = document.querySelector('.btn');
            const oldText = btn.textContent;
            btn.textContent = 'Loading...';
            btn.disabled = true;

            const priceData = await fetchRealPrice(symbol);

            btn.textContent = oldText;
            btn.disabled = false;

            if (!priceData) {
                alert(`Could not fetch price for ${symbol}. Check symbol or try again.`);
                return;
            }

            watchlist.push({
                symbol,
                price: priceData.price.toFixed(2),
                change: priceData.change.toFixed(2),
                percent: priceData.percent.toFixed(2)
            });
            input.value = '';
            updateWatchlist();
        }

        async function refreshPrices() {
            if (watchlist.length === 0) return;
            for (let stock of watchlist) {
                const priceData = await fetchRealPrice(stock.symbol);
                if (priceData) {
                    stock.price = priceData.price.toFixed(2);
                    stock.change = priceData.change.toFixed(2);
                    stock.percent = priceData.percent.toFixed(2);
                }
            }
            updateWatchlist();
        }

        function removeFromWatchlist(symbol) {
            watchlist = watchlist.filter(w => w.symbol !== symbol);
            updateWatchlist();
        }

        function updateWatchlist() {
            const container = document.getElementById('watchlist');
            if (watchlist.length === 0) {
                container.innerHTML =
                    '<div class="empty-state"><div class="empty-state-icon">üìã</div><p>No stocks in watchlist. Add one above.</p></div>';
                return;
            }

            container.innerHTML = watchlist.map(stock => {
                const changeNum = parseFloat(stock.change);
                const percentNum = parseFloat(stock.percent);
                const isUp = changeNum >= 0;
                const alert = Math.abs(percentNum) >= ALERT_THRESHOLD;

                return `
                    <div class="ticker-card ${alert ? 'alert-row' : ''}" onclick="showDetails('${stock.symbol}')">
                        <div class="ticker-header">
                            <span class="ticker-symbol">${stock.symbol}</span>
                            <span class="ticker-price ${isUp ? 'up' : 'down'}">$${stock.price}</span>
                        </div>
                        <div class="ticker-change">
                            <span>
                                <span class="change-value ${isUp ? 'up' : 'down'}">
                                    ${isUp ? '+' : ''}${stock.change}
                                </span>
                                <span class="change-percent">
                                    (${percentNum >= 0 ? '+' : ''}${stock.percent}%)
                                </span>
                                ${alert ? `<span class="alert-badge">Alert ${percentNum.toFixed(1)}%</span>` : ''}
                            </span>
                            <span class="ticker-right" onclick="event.stopPropagation();">
                                <canvas class="sparkline" id="spark-${stock.symbol}"></canvas>
                                <button class="btn-danger" onclick="removeFromWatchlist('${stock.symbol}')">Remove</button>
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            watchlist.forEach(async stock => {
                const canvas = document.getElementById(`spark-${stock.symbol}`);
                if (!canvas) return;
                canvas.width = 80;
                canvas.height = 24;

                if (candleCache[stock.symbol]) {
                    drawSparkline(canvas, candleCache[stock.symbol]);
                } else {
                    const prices = await fetchIntradayCandles(stock.symbol);
                    if (prices) {
                        candleCache[stock.symbol] = prices;
                        drawSparkline(canvas, prices);
                    }
                }
            });
        }

        async function fetchCompanyProfile(symbol) {
            try {
                const url = `https://finnhub.io/api/v1/stock/profile2?symbol=${encodeURIComponent(symbol)}&token=${FINNHUB_API_KEY}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`Profile error: ${res.status}`);
                const data = await res.json();
                if (!data || Object.keys(data).length === 0) return null;
                return data;
            } catch (err) {
                console.error('Profile error for', symbol, err);
                return null;
            }
        }

        async function fetchCompanyNews(symbol) {
            try {
                const today = new Date();
                const fromDate = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
                const fmt = d => d.toISOString().slice(0, 10);
                const url = `https://finnhub.io/api/v1/company-news?symbol=${encodeURIComponent(symbol)}&from=${fmt(fromDate)}&to=${fmt(today)}&token=${FINNHUB_API_KEY}`;
                const res = await fetch(url);
                if (!res.ok) throw new Error(`News error: ${res.status}`);
                const data = await res.json();
                if (!Array.isArray(data)) return [];
                return data.slice(0, 5);
            } catch (err) {
                console.error('News error for', symbol, err);
                return [];
            }
        }

        async function showDetails(symbol) {
            const panel = document.getElementById('panel-details');
            const title = document.getElementById('detailsTitle');
            const body = document.getElementById('detailsBody');

            panel.style.display = 'block';
            title.textContent = `${symbol} ‚Äì Details`;
            body.innerHTML = `<div style="font-size:13px; color:var(--color-text-secondary);">Loading...</div>`;

            const [profile, quote, news] = await Promise.all([
                fetchCompanyProfile(symbol),
                fetchRealPrice(symbol),
                fetchCompanyNews(symbol)
            ]);

            let profileHtml = '';
            if (profile) {
                profileHtml = `
                    <div style="margin-bottom:12px;">
                        <div style="font-size:14px; font-weight:600;">${profile.name || symbol}</div>
                        <div style="font-size:12px; color:var(--color-text-secondary);">
                            ${profile.exchange || ''} ¬∑ ${profile.country || ''} ¬∑ ${profile.currency || ''}
                        </div>
                    </div>
                `;
            }

            let quoteHtml = '';
            if (quote) {
                const isUp = quote.change >= 0;
                quoteHtml = `
                    <div style="margin-bottom:12px;">
                        <div style="font-size:24px; font-weight:700;">
                            $${quote.price.toFixed(2)}
                            <span style="font-size:13px; margin-left:6px; color:${isUp ? '#22c55e' : '#ff6b6b'};">
                                ${isUp ? '+' : ''}${quote.change.toFixed(2)} (${quote.percent >= 0 ? '+' : ''}${quote.percent.toFixed(2)}%)
                            </span>
                        </div>
                        <div style="font-size:11px; color:var(--color-text-secondary);">
                            O: ${quote.open?.toFixed ? quote.open.toFixed(2) : '-'} ¬∑
                            H: ${quote.high?.toFixed ? quote.high.toFixed(2) : '-'} ¬∑
                            L: ${quote.low?.toFixed ? quote.low.toFixed(2) : '-'} ¬∑
                            Prev: ${quote.prevClose?.toFixed ? quote.prevClose.toFixed(2) : '-'}
                        </div>
                    </div>
                `;
            }

            let newsHtml = '';
            if (news && news.length) {
                newsHtml = `
                    <div style="margin-top:8px;">
                        <div style="font-size:11px; text-transform:uppercase; color:var(--color-text-secondary); margin-bottom:4px;">Recent News</div>
                        ${news
                            .map(
                                n => `
                            <div style="margin-bottom:8px;">
                                <div style="font-size:12px; font-weight:600;">${n.headline}</div>
                                <div style="font-size:11px; color:var(--color-text-secondary);">
                                    ${n.source || ''} ¬∑ ${n.datetime ? new Date(n.datetime * 1000).toLocaleString() : ''}
                                </div>
                            </div>
                        `
                            )
                            .join('')}
                    </div>
                `;
            } else {
                newsHtml = `<div style="font-size:11px; color:var(--color-text-secondary); margin-top:8px;">No recent company news.</div>`;
            }

            body.innerHTML = profileHtml + quoteHtml + newsHtml;
        }

        function switchView(view) {
            currentView = view;
            const header = document.getElementById('headerTitle');
            const views = {
                watchlist: 'Markets Overview',
                news: 'Breaking News',
                sectors: 'Sector Analysis',
                screener: 'Stock Screener',
                alerts: 'Price Alerts'
            };
            header.textContent = views[view] || 'Markets Overview';
        }

        function handleSearch() {
            // Placeholder
        }

        init();
        setInterval(refreshPrices, 30000);

        document.addEventListener('click', e => {
            const panel = document.getElementById('panel-details');
            if (!panel) return;
            if (panel.style.display === 'none') return;
            if (!panel.contains(e.target)) {
                panel.style.display = 'none';
            }
        });
    </script>
</body>
</html>
