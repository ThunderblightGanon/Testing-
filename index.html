<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Advanced Stock Tracker</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">

  <div class="max-w-5xl mx-auto grid md:grid-cols-3 gap-6">

    <!-- LEFT: SEARCH & WATCHLIST -->
    <div class="bg-white rounded-2xl shadow p-4">
      <h2 class="text-xl font-bold mb-3">üîç Stock Search</h2>
      <input id="symbolInput" type="text" placeholder="AAPL"
        class="w-full border rounded-lg px-3 py-2 mb-2" />
      <button onclick="loadStock()"
        class="w-full bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700">Search</button>

      <h3 class="font-semibold mt-6 mb-2">‚≠ê Watchlist</h3>
      <ul id="watchlist" class="space-y-2"></ul>
    </div>

    <!-- RIGHT: STOCK INFO -->
    <div class="md:col-span-2 bg-white rounded-2xl shadow p-4">
      <div id="error" class="text-red-600 hidden"></div>

      <div id="stockSection" class="hidden">
        <div class="flex justify-between items-center mb-4">
          <h1 id="stockTitle" class="text-2xl font-bold"></h1>
          <button onclick="addToWatchlist()"
            class="bg-green-600 text-white px-3 py-1 rounded-lg">+ Watch</button>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          <div class="p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-500">Price</p>
            <p id="price" class="font-semibold"></p>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-500">Change</p>
            <p id="change"></p>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-500">Volume</p>
            <p id="volume"></p>
          </div>
          <div class="p-3 bg-gray-50 rounded">
            <p class="text-sm text-gray-500">Last Day</p>
            <p id="lastDay"></p>
          </div>
        </div>

        <canvas id="priceChart" height="120"></canvas>
      </div>
    </div>
  </div>

<script>
const API_KEY = "7A48DHS27SKTE670";
let currentSymbol = "";
let chart;

// ---------------- WATCHLIST ----------------
function getWatchlist() {
  return JSON.parse(localStorage.getItem("watchlist") || "[]");
}

function saveWatchlist(list) {
  localStorage.setItem("watchlist", JSON.stringify(list));
  renderWatchlist();
}

function addToWatchlist() {
  const list = getWatchlist();
  if (!list.includes(currentSymbol)) {
    list.push(currentSymbol);
    saveWatchlist(list);
  }
}

function removeFromWatchlist(symbol) {
  const list = getWatchlist().filter(s => s !== symbol);
  saveWatchlist(list);
}

function renderWatchlist() {
  const ul = document.getElementById("watchlist");
  ul.innerHTML = "";
  getWatchlist().forEach(symbol => {
    const li = document.createElement("li");
    li.className = "flex justify-between items-center bg-gray-100 px-3 py-2 rounded cursor-pointer";
    li.innerHTML = `
      <span onclick="loadStock('${symbol}')">${symbol}</span>
      <button onclick="removeFromWatchlist('${symbol}')" class="text-red-500">‚úï</button>
    `;
    ul.appendChild(li);
  });
}

// ---------------- STOCK LOAD ----------------
async function loadStock(symbolOverride) {
  const symbol = (symbolOverride || document.getElementById("symbolInput").value)
    .trim().toUpperCase();

  if (!symbol) return;
  currentSymbol = symbol;

  document.getElementById("error").classList.add("hidden");

  try {
    const quoteUrl = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${symbol}&apikey=${API_KEY}`;
    const dailyUrl = `https://www.alphavantage.co/query?function=TIME_SERIES_DAILY&symbol=${symbol}&apikey=${API_KEY}`;

    const [quoteRes, dailyRes] = await Promise.all([
      fetch(quoteUrl), fetch(dailyUrl)
    ]);

    const quoteData = await quoteRes.json();
    const dailyData = await dailyRes.json();

    if (!quoteData['Global Quote']) throw new Error("Invalid symbol or API limit reached");

    const q = quoteData['Global Quote'];

    document.getElementById("stockTitle").textContent = symbol;
    document.getElementById("price").textContent = `$${(+q['05. price']).toFixed(2)}`;

    const ch = +q['09. change'];
    const chEl = document.getElementById("change");
    chEl.textContent = `${ch.toFixed(2)} (${q['10. change percent']})`;
    chEl.className = ch >= 0 ? "text-green-600" : "text-red-600";

    document.getElementById("volume").textContent = (+q['06. volume']).toLocaleString();
    document.getElementById("lastDay").textContent = q['07. latest trading day'];

    document.getElementById("stockSection").classList.remove("hidden");

    drawChart(dailyData['Time Series (Daily)']);

  } catch (e) {
    const err = document.getElementById("error");
    err.textContent = e.message;
    err.classList.remove("hidden");
  }
}

// ---------------- CHART ----------------
function drawChart(series) {
  const dates = Object.keys(series).slice(0, 30).reverse();
  const prices = dates.map(d => +series[d]['4. close']);

  if (chart) chart.destroy();

  chart = new Chart(document.getElementById("priceChart"), {
    type: 'line',
    data: {
      labels: dates,
      datasets: [{
        label: 'Closing Price',
        data: prices,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } }
    }
  });
}

renderWatchlist();
</script>
</body>
</html>
